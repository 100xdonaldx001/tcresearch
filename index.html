<!doctype html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>Thaumcraft 4.1 Research Helper</title>
		<script type="text/javascript" src="buckets-minified.js"></script>
		<script>
			graph = {};
			function connect(aspect1, aspect2) {
				function addConnection(from, to) {
					if (!(from in graph)) graph[from] = [];
					graph[from].push(to);
				}
				addConnection(aspect1, aspect2);
				addConnection(aspect2, aspect1);
			}

			function output(path) {
				var output = [];
				path.forEach(function(e) {
					output.push(translate[e] + " (" + e + ")");
				});
				return output.join(" -> ");
			}

			function find(from, to, steps) {
				function search(queue, to, visited) {
					while (!queue.isEmpty()) {
						var element = queue.dequeue();
						//alert("path: " + element.path + "\nqueue: " + debug(queue));
						var node = element.path.pop();
						if (!(node in visited) || visited[node].indexOf(element.path.length) < 0) {
							element.path.push(node);
							if (node == to && element.path.length > steps + 1) return element.path;
							graph[node].forEach(function(entry) {
								var newpath = element.path.slice();
								newpath.push(entry);
								queue.enqueue({"path":newpath,"length":element.length+getWeight(entry)});
							});
							if (!(node in visited)) visited[node] = [];
							visited[node].push(element.path.length-1);
						}
					}
					return null;
				}

				var queue = new buckets.PriorityQueue(function(a,b) {
					return b.length-a.length;
				});
				queue.enqueue({"path":[from],"length":0});
				visited = {};
				//alert("visited: " + visited + "\nqueue: " + debug(queue));
				return search(queue, to, visited);
			}
			
			combinations = { "void": ["air", "entropy"], "light": ["air", "fire"], "energy": ["order", "fire"], "motion": ["air", "order"], "stone": ["earth", "earth"], "life": ["water", "earth"], "weather": ["air", "water"], "ice": ["water", "order"], "crystal": ["stone", "water"], "death": ["life", "entropy"], "flight": ["air", "motion"], "darkness": ["void", "light"], "soul": ["life", "death"], "heal": ["life", "life"], "travel": ["motion", "earth"], "poison": ["water", "death"], "eldritch": ["void", "darkness"], "magic": ["void", "energy"], "aura": ["magic", "air"], "taint": ["magic", "entropy"], "seed": ["life", "earth"], "slime": ["life", "water"], "plant": ["seed", "earth"], "tree": ["earth", "plant"], "beast": ["motion", "life"], "flesh": ["death", "beast"], "undead": ["motion", "death"], "mind": ["earth", "soul"], "senses": ["air", "soul"], "man": ["beast", "mind"], "crop": ["seed", "man"], "harvest": ["crop", "man"], "metal": ["stone", "order"], "mine": ["man", "stone"], "tool": ["man", "order"], "weapon": ["tool", "entropy"], "armor": ["tool", "earth"], "hunger": ["life", "void"], "greed": ["man", "hunger"], "craft": ["man", "tool"], "cloth": ["tool", "beast"], "mechanism": ["motion", "tool"], "trap": ["motion", "entropy"], "exchange": ["motion", "water"] };
			translate = { "air": "aer", "earth": "terra", "fire": "ignis", "water": "aqua", "order": "ordo", "entropy": "perditio", "void": "vacuos", "light": "lux", "energy": "potentia", "motion": "motus", "stone": "saxum", "life": "victus", "weather": "tempestas", "ice": "gelum", "crystal": "vitreus", "death": "mortuus", "flight": "volatus", "darkness": "tenebrae", "soul": "spiritus", "heal": "sano", "travel": "iter", "poison": "venenum", "eldritch": "alienis", "magic": "praecantatio", "aura": "auram", "taint": "vitium", "seed": "granum", "slime": "limus", "plant": "herba", "tree": "arbor", "beast": "bestia", "flesh": "corpus", "undead": "exanimis", "mind": "cognitio", "senses": "sensus", "man": "humanus", "crop": "messis", "harvest": "meto", "metal": "metallum", "mine": "perfodio", "tool": "instrumentum", "weapon": "telum", "armor": "tutamen", "hunger": "fames", "greed": "lucrum", "craft": "fabrico", "cloth": "pannus", "mechanism": "machina", "trap": "vinculum", "exchange": "permutatio" };
			aspects = [ "air", "earth", "fire", "water", "order", "entropy", "void", "light", "energy", "motion", "stone", "life", "weather", "ice", "crystal", "death", "flight", "darkness", "soul", "heal", "travel", "poison", "eldritch", "magic", "aura", "taint", "seed", "slime", "plant", "tree", "beast", "flesh", "undead", "mind", "senses", "man", "crop", "harvest", "metal", "mine", "tool", "weapon", "armor", "hunger", "greed", "craft", "cloth", "mechanism", "trap", "exchange" ].sort(function(a,b){
				return (a == b) ? 0 : (translate[a]<translate[b]) ? -1 : 1;
			});

			for (compound in combinations) {
				connect(compound, combinations[compound][0]);
				connect(compound, combinations[compound][1]);
			}

			window.onload = function() {
				function option(value, text) {
					var option = document.createElement("option");
					option.value = value;
					option.textContent = text;
					return option;
				}

				fromSel = document.getElementById("fromSel");
				toSel = document.getElementById("toSel");
				stepSel = document.getElementById("steps");
				check = document.getElementById("available");
				var i = 0;
				aspects.forEach(function(aspect) {
					fromSel.appendChild(option(aspect, translate[aspect] + " (" + aspect + ")"));
					toSel.appendChild(option(aspect, translate[aspect] + " (" + aspect + ")"));
					var checkbox = document.createElement('input');
					checkbox.type = "checkbox";
					//checkbox.name = "check" + aspect;
					checkbox.value = aspect;
					checkbox.id = "check" + aspect;
					checkbox.checked = "checked";
					var label = document.createElement('label')
					label.htmlFor = "check" + aspect;
					label.appendChild(document.createTextNode(translate[aspect] + " (" + aspect + ")"));
					check.appendChild(checkbox);
					check.appendChild(label);
					i++;
					if (i > 3) {
						i = 0;
						check.appendChild(document.createElement("br"));
					}
				});
				for (var i=0; i<11; i++) {
					stepSel.appendChild(option(i, "" + i));
				}
			};

			function run() {
				alert(output(find(fromSel.options[fromSel.selectedIndex].value, toSel.options[toSel.selectedIndex].value, stepSel.selectedIndex)));
			}

			function getWeight(aspect) {
				var el = document.getElementById("check" + aspect);
				return (el.checked) ? 1 : 100;
			}
		</script>
	</head>
	<body>
		<h2>Thaumcraft 4.1 Research Helper</h2>
		<table>
			<tr><td>Available<br/>Aspects:</td><td id="available"></td></tr>
			<tr><td>From:</td><td><select id="fromSel"></select></td></tr>
			<tr><td>To:</td><td><select id="toSel"></select></td></tr>
			<tr><td>Min. Steps:</td><td><select id="steps"></select></td></tr>
			<tr><td></td><td><a href="javascript: run();">Find Connection</a></td></tr>
		</table>
	</body>
</html>
